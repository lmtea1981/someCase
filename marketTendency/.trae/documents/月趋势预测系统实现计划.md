# 月趋势预测系统实现计划（Agent+Token统计版）

## 项目概述
创建一个基于langchain 1.2框架的月趋势预测系统，使用LangChain Agent协调工作流程，封装网页提取和搜索为LangChain Tools，先通过ollama模型调试，支持流输出，并在最后输出token用量统计。

## 技术栈
- LangChain 1.2
- Ollama模型（调试阶段）
- 千帆/其他第三方模型（后期切换）
- Python

## 项目结构
```
marketTendency/
├── main.py                 # 主程序入口
├── config.py               # 配置文件
├── agent/                  # Agent模块
│   ├── market_agent.py     # 市场趋势分析Agent
│   └── agent_prompt.py     # Agent提示词
├── tools/                  # LangChain Tools模块
│   ├── cls_extractor_tool.py  # CLS投资日历提取Tool
│   └── web_search_tool.py     # 网络搜索Tool
├── chains/                 # LangChain Chains模块
│   ├── event_chain.py          # 事件分析链
│   ├── sector_chain.py         # 板块分析链
│   ├── cycle_chain.py          # 投资周期链
│   └── strategy_chain.py       # 投资策略链
├── llm/                    # LLM集成模块
│   ├── ollama_llm.py       # Ollama模型集成
│   ├── qianfan_llm.py      # 千帆模型集成
│   └── token_counter.py    # Token用量统计
└── utils/                  # 工具模块
    └── streaming_output.py # 流输出工具
```

## 工作流程设计（Agent驱动）

### 核心Agent设计
**名称**：市场趋势分析Agent
**角色**：协调各工具和链，完成从信息提取到建议生成的全流程

**Agent能力**：
- 调用CLS提取Tool获取投资日历
- 调用网络搜索Tool获取关联资讯
- 协调各分析链进行综合分析
- 生成最终投资建议
- 统计并输出token用量

### 工作流程步骤

#### 1. 信息提取阶段
- Agent调用`cls_extractor_tool`从cls.cn提取投资日历
- 工具返回结构化的事件列表
- Agent将事件列表传递给下一阶段

#### 2. 关联资讯搜索阶段
- Agent为重要事件生成搜索关键词
- 调用`web_search_tool`搜索相关资讯
- 整合搜索结果，丰富事件背景信息

#### 3. 综合分析阶段
- Agent协调各分析链：
  - `event_chain`：分析事件热度、影响、趋势
  - `sector_chain`：分析板块利好、风险
  - `cycle_chain`：分析投资周期
  - `strategy_chain`：制定投资策略
- 各链协同工作，形成综合分析结果

#### 4. 建议生成阶段
- Agent基于综合分析结果生成最终建议，包括：
  - 投资领域推荐
  - 投资策略建议
  - 配置文案推荐
  - 加仓/减仓窗口
  - 总结和建议

#### 5. Token用量统计阶段
- 统计整个流程中使用的token数量
- 输出token用量报告

## 关键功能实现

### 1. Agent实现
- 使用LangChain的AgentExecutor实现
- 配置合适的Agent类型（如ReAct Agent）
- 设计详细的Agent提示词，明确工作流程和目标
- 支持Agent内存，保存中间结果

### 2. Token用量统计
- 实现`token_counter.py`，集成LangChain的TokenUsageTracker
- 统计以下token用量：
  - 输入token（prompt）
  - 输出token（completion）
  - 总token用量
- 支持不同模型的token计算
- 最后输出详细的token用量报告

### 3. 流输出实现
- 配置LLM的streaming=True
- 实现`streaming_output.py`，优化流输出展示
- 实时展示Agent思考过程和分析结果
- 保持流输出的连贯性和可读性

### 4. Tools封装
- `cls_extractor_tool.py`：封装网页抓取和解析逻辑
- `web_search_tool.py`：封装网络搜索功能
- 所有工具遵循LangChain Tool接口规范
- 支持工具输入输出的类型定义

### 5. Chains实现
- 各分析链专注于单一分析任务
- 支持链的组合和嵌套
- 链的输出作为Agent的输入或下一个链的输入

## 执行步骤

### 1. 项目初始化
- 创建项目目录结构
- 安装依赖：langchain 1.2、ollama-python、requests、beautifulsoup4等

### 2. Tools实现
- 实现`cls_extractor_tool.py`：提取CLS投资日历
- 实现`web_search_tool.py`：网络搜索功能

### 3. LLM集成与Token统计
- 实现`ollama_llm.py`：集成ollama模型
- 实现`token_counter.py`：token用量统计功能
- 配置流输出模式

### 4. Chains实现
- 实现各分析链：event_chain、sector_chain、cycle_chain、strategy_chain

### 5. Agent实现
- 设计Agent提示词
- 实现`market_agent.py`：配置和初始化Agent
- 测试Agent调用流程

### 6. 主程序实现
- 实现`main.py`：整合所有模块
- 配置Agent执行流程
- 添加token用量统计输出

### 7. 测试与优化
- 使用ollama模型进行调试
- 测试Agent工作流程的完整性
- 优化Agent提示词和工具调用
- 测试token统计准确性
- 准备切换到千帆或其他第三方模型

## 预期功能
- 使用LangChain Agent协调完整工作流程
- 自动从cls.cn提取投资日历信息
- 智能搜索事件相关资讯
- 综合分析事件影响和趋势
- 提供结构化的投资建议
- 流畅的流输出体验
- 详细的token用量统计报告

## 后续扩展
- 支持多Agent协作
- 实现历史数据对比分析
- 添加可视化输出
- 支持更多模型切换
- 优化token使用效率

## 最终输出格式

### 分析结果（流输出）
```
=== 月趋势预测分析 ===

1. 投资日历信息
- 日期：2026-01-19
  事件：第56届世界经济论坛年会
  类型：国际会议
  ...

2. 事件影响分析
- 世界经济论坛：热度高，影响全球市场...
- 央行政策：直接影响货币政策和流动性...

3. 板块利好/风险
- 利好板块：...
- 风险板块：...

4. 投资周期建议
- 短期（1-2周）：...
- 中期（1-3个月）：...

5. 投资建议
- 投资领域：...
- 投资策略：...
- 配置文案：...
- 加仓窗口：...
- 减仓窗口：...
- 总结建议：...
```

### Token用量统计（最终输出）
```
=== Token用量统计 ===
模型：ollama
输入Token：XXXX
输出Token：XXXX
总Token：XXXX
成本估算：XXXX
```

## 执行步骤
1. 创建项目结构和基础文件
2. 实现LangChain Tools
3. 集成LLM和Token统计
4. 实现分析Chains
5. 设计和实现Market Agent
6. 实现主程序和流输出
7. 测试和优化
8. 准备切换到其他模型